{% extends "base.html" %}
{% block title %}Novo Pedido – Pedido de Materiais{% endblock %}

{% block content %}
<style>
  /* === Layout geral === */
  html, body {
    height: 100%;
    margin: 0;
    overflow: hidden; /* evita scroll externo, footer sempre visível */
  }
  main.container {
    height: calc(100vh - 120px); /* header + footer = 120px */
    overflow-y: auto;             /* scroll interno no main */
    padding: 1rem;
  }

  .section-card {
    background: var(--card);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .section-header {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: .5rem;
    margin-bottom: 1rem;
  }

  .form-control-sm {
    font-size: .9rem;
    padding: .5rem;
  }
  .btn-sm {
    font-size: .9rem;
    padding: .45rem .75rem;
    transition: transform .2s ease-in-out;
  }
  .btn-sm:active {
    transform: scale(.97);
  }

  .input-group-text {
    background: white;
    border-left: 0;
    cursor: pointer;
  }

  /* === Scroll interno na lista de produtos === */
  #produtos-list {
    max-height: 180px;
    overflow-y: auto;
  }

  /* === Itens adicionados: quando >5 linhas vira scroll === */
  .table-responsive {
    /* altura aproximada de 5 linhas + header */
    max-height: calc(5 * 2.5rem + 2.5rem);
    overflow-y: auto;
  }
  .table-responsive thead th {
    position: sticky;
    top: 0;
    background: #f8f9fa;
    z-index: 1;
  }

  /* === Modal personalizado === */
  .modal-header {
    background: #dc3545;
    color: #fff;
  }
  .modal-title {
    display: flex;
    align-items: center;
    gap: .5rem;
  }
</style>

<main class="container">

  <div class="section-card">
    <div class="section-header">
      <i class="bi bi-plus-circle-fill"></i> Adicionar Material
    </div>
    <form method="post" class="row gy-3 gx-3 align-items-end" onsubmit="return !!produtoId.value">
      <div class="col-lg-6 col-md-8">
        <label for="produto-search" class="form-label">Produto</label>
        <div class="input-group">
          <input
            type="text"
            id="produto-search"
            class="form-control form-control-sm"
            placeholder="Pesquisar produto..."
            oninput="filterProdutos()"
            autocomplete="off"
          >
          <span class="input-group-text"><i class="bi bi-search"></i></span>
        </div>
      </div>
      <div class="col-lg-2 col-md-4">
        <label for="quantity" class="form-label">Quantidade</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-123"></i></span>
          <input
            type="number"
            id="quantity"
            name="quantity"
            class="form-control form-control-sm"
            min="1"
            value="1"
            required
          >
        </div>
      </div>
      <div class="col-lg-2 col-md-4 d-grid">
        <button
          class="btn btn-primary w-100 btn-sm"
          type="submit"
          id="btn-adicionar"
          disabled
        >
          <i class="bi bi-plus-lg me-1"></i> Adicionar
        </button>
      </div>
      <input type="hidden" name="produto_id" id="produtoId">
    </form>

    <div id="produtos-list" class="list-group mt-3">
      {% for prod_id, prod_nome in produtos %}
        <button
          type="button"
          class="list-group-item list-group-item-action"
          data-id="{{ prod_id }}"
          onclick="selectProduto(this)"
        >{{ prod_nome }}</button>
      {% endfor %}
    </div>
  </div>

  <div class="section-card">
    <div class="section-header">
      <i class="bi bi-basket-fill"></i> Itens Adicionados
    </div>
    <div class="table-responsive">
      <table class="table table-sm table-hover table-striped mb-0">
        <thead>
          <tr>
            <th class="text-center">Produto</th>
            <th class="text-center">Qtd.</th>
            <th class="text-center">Ações</th>
          </tr>
        </thead>
        <tbody id="itens-tbody">
          {% if itens %}
            {% for item_id, nome, quantity in itens %}
            <tr data-item-id="{{ item_id }}">
              <td class="text-center">{{ nome }}</td>
              <td class="text-center">{{ quantity }}</td>
              <td class="text-center">
                <button
                  type="button"
                  class="btn btn-sm btn-outline-danger"
                  onclick="confirmRemove({{ item_id }}, this)"
                  title="Remover"
                >
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="3" class="text-center text-muted py-4">
                Nenhum item adicionado.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

</main>

<!-- Modal de Confirmação -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalLabel">
          <i class="bi bi-exclamation-triangle-fill"></i> Confirmar remoção
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        Tem certeza que deseja remover este item da lista?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          <i class="bi bi-trash-fill me-1"></i> Remover
        </button>
      </div>
    </div>
  </div>
</div>

{% block scripts %}
<script>
  let selectedButton = null;
  let deleteTarget = { id: null, btn: null };

  function filterProdutos() {
    const term = produtoSearch.value.toLowerCase();
    document.querySelectorAll('#produtos-list button').forEach(btn => {
      btn.style.display = btn.textContent.toLowerCase().includes(term) ? '' : 'none';
    });
  }

  function selectProduto(btn) {
    if (selectedButton) selectedButton.classList.remove('active');
    btn.classList.add('active');
    selectedButton = btn;
    produtoId.value = btn.dataset.id;
    btnAdicionar.disabled = false;
  }

  function confirmRemove(itemId, btn) {
    deleteTarget = { id: itemId, btn };
    new bootstrap.Modal(confirmModal).show();
  }

  confirmDeleteBtn.addEventListener('click', () => {
    if (!deleteTarget.id) return;
    fetch(`{{ url_for('remove_item', item_id=0) }}`.replace('0', deleteTarget.id), { method: 'POST' })
      .then(() => {
        deleteTarget.btn.closest('tr').remove();
        bootstrap.Modal.getInstance(confirmModal).hide();
      });
  });
</script>
{% endblock %}

{% endblock %}
